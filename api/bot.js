const { Telegraf } = require('telegraf');

const BOT_TOKEN = process.env.BOT_TOKEN;
if (!BOT_TOKEN) {
  console.error('âŒ BOT_TOKEN Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½!');
  process.exit(1);
}

const bot = new Telegraf(BOT_TOKEN);

// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð²Ñ‹Ñ…Ð¾Ð´Ð° Ð¸Ð· Ð²ÑÐµÑ… Ñ‡Ð°Ñ‚Ð¾Ð²
async function leaveAllChats() {
  try {
    // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ð±Ð¾Ñ‚Ðµ
    const botInfo = await bot.telegram.getMe();
    console.log(`ðŸ¤– Ð‘Ð¾Ñ‚ ${botInfo.first_name} Ð½Ð°Ñ‡Ð¸Ð½Ð°ÐµÑ‚ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ...`);
    
    // Ð—Ð´ÐµÑÑŒ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ ÐºÐ¾Ð´ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÑÐ¿Ð¸ÑÐºÐ° Ð²ÑÐµÑ… Ñ‡Ð°Ñ‚Ð¾Ð², Ð³Ð´Ðµ ÑÐ¾ÑÑ‚Ð¾Ð¸Ñ‚ Ð±Ð¾Ñ‚
    // Ðš ÑÐ¾Ð¶Ð°Ð»ÐµÐ½Ð¸ÑŽ, Telegram Bot API Ð½Ðµ Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÑÐµÑ‚ Ð¼ÐµÑ‚Ð¾Ð´ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÑÑ‚Ð¾Ð³Ð¾ ÑÐ¿Ð¸ÑÐºÐ°
    // ÐŸÐ¾ÑÑ‚Ð¾Ð¼Ñƒ Ð½ÑƒÐ¶Ð½Ð¾ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ ÑƒÐºÐ°Ð·Ð°Ñ‚ÑŒ ID Ñ‡Ð°Ñ‚Ð¾Ð², Ð¸Ð· ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ñ… Ð½ÑƒÐ¶Ð½Ð¾ Ð²Ñ‹Ð¹Ñ‚Ð¸
    
    const knownChats = [
      -1002818324656, // Ð§Ð°Ñ‚ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸ ðŸ›ï¸
      -1002894920473, // ÐžÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ñ‡Ð°Ñ‚ ðŸ§¨
      -1002899007927, // ÐšÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¸ ÐºÐ°Ð½Ð°Ð»Ð° Ð¯ Ð¡Ð¿ÐµÐºÑ‚Ñ€ â™¦ï¸
      // Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ ÑÑŽÐ´Ð° Ð´Ñ€ÑƒÐ³Ð¸Ðµ ID Ñ‡Ð°Ñ‚Ð¾Ð², Ð¸Ð· ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ñ… Ð½ÑƒÐ¶Ð½Ð¾ Ð²Ñ‹Ð¹Ñ‚Ð¸
    ];
    
    // Ð’Ñ‹Ñ…Ð¾Ð´Ð¸Ð¼ Ð¸Ð· Ð²ÑÐµÑ… Ð¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ñ… Ñ‡Ð°Ñ‚Ð¾Ð²
    for (const chatId of knownChats) {
      try {
        // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð¿Ñ€Ð¾Ñ‰Ð°Ð»ÑŒÐ½Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
        await bot.telegram.sendMessage(
          chatId,
          'ðŸ‘‹ ÐŸÑ€Ð¾Ñ‰Ð°Ð¹Ñ‚Ðµ! Ð‘Ð¾Ñ‚ Ð¿Ñ€ÐµÐºÑ€Ð°Ñ‰Ð°ÐµÑ‚ ÑÐ²Ð¾ÑŽ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ. Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾ Ð·Ð° Ð²ÑÑ‘! ðŸŽ‰\n\n' +
          'Ð•ÑÐ»Ð¸ Ð¿Ð¾Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ ÑÐ½Ð¾Ð²Ð° Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð±Ð¾Ñ‚Ð°, Ð¾Ð±Ñ€Ð°Ñ‚Ð¸Ñ‚ÐµÑÑŒ Ðº Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ°Ð¼.'
        );
        
        // Ð’Ñ‹Ñ…Ð¾Ð´Ð¸Ð¼ Ð¸Ð· Ñ‡Ð°Ñ‚Ð°
        await bot.telegram.leaveChat(chatId);
        console.log(`âœ… Ð’Ñ‹ÑˆÐ»Ð¸ Ð¸Ð· Ñ‡Ð°Ñ‚Ð° ${chatId}`);
        
        // ÐÐµÐ±Ð¾Ð»ÑŒÑˆÐ°Ñ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÐ° Ð¼ÐµÐ¶Ð´Ñƒ Ð²Ñ‹Ñ…Ð¾Ð´Ð°Ð¼Ð¸
        await new Promise(resolve => setTimeout(resolve, 1000));
      } catch (error) {
        console.error(`âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð²Ñ‹Ñ…Ð¾Ð´Ðµ Ð¸Ð· Ñ‡Ð°Ñ‚Ð° ${chatId}:`, error.message);
      }
    }
    
    console.log('âœ… Ð‘Ð¾Ñ‚ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð²Ñ‹ÑˆÐµÐ» Ð¸Ð· Ð²ÑÐµÑ… Ñ‡Ð°Ñ‚Ð¾Ð². Ð—Ð°Ð²ÐµÑ€ÑˆÐ°ÐµÐ¼ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ...');
    
  } catch (error) {
    console.error('âŒ ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ°:', error);
  } finally {
    // Ð—Ð°Ð²ÐµÑ€ÑˆÐ°ÐµÐ¼ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ
    process.exit(0);
  }
}

// Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ Ð²Ñ‹Ñ…Ð¾Ð´Ð°
leaveAllChats();

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð´Ð»Ñ Ð½ÐµÐ¼ÐµÐ´Ð»ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð²Ñ‹Ñ…Ð¾Ð´Ð° Ð¿Ñ€Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ð¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ (Ð½Ð° ÑÐ»ÑƒÑ‡Ð°Ð¹ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸)
bot.command('shutdown', async (ctx) => {
  await ctx.reply('ðŸ›‘ ÐÐ°Ñ‡Ð¸Ð½Ð°ÑŽ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ...');
  leaveAllChats();
});

// Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð±Ð¾Ñ‚Ð° Ð´Ð»Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ shutdown
bot.launch().then(() => {
  console.log('ðŸ”„ Ð‘Ð¾Ñ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð´Ð»Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /shutdown');
});

// ÐŸÑ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾ Ð¾Ð±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ°
process.once('SIGINT', () => leaveAllChats());
process.once('SIGTERM', () => leaveAllChats());
